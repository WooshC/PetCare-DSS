version: '3.8'
services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD}
    volumes:
      - sqlvolume:/var/opt/mssql
    restart: always

  petcare-auth:
    image: petcareregistry123.azurecr.io/petcare-auth:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=db;Database=AuthDB;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
    depends_on: [ db ]
    restart: always

  petcare-cliente:
    image: petcareregistry123.azurecr.io/petcare-cliente:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=db;Database=ClienteDB;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
      - Services__AuthServiceUrl=http://petcare-auth:8080
    depends_on: [ db, petcare-auth ]
    restart: always

  petcare-cuidador:
    image: petcareregistry123.azurecr.io/petcare-cuidador:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=db;Database=CuidadorDB;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
      - Services__AuthServiceUrl=http://petcare-auth:8080
      - Services__RatingServiceUrl=http://petcare-calificar:8080
    depends_on: [ db, petcare-auth ]
    restart: always

  petcare-request:
    image: petcareregistry123.azurecr.io/petcare-request:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=db;Database=RequestDB;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
    depends_on: [ db ]
    restart: always

  petcare-payment:
    image: petcareregistry123.azurecr.io/petcare-payment:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=db;Database=PaymentDB;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
    depends_on: [ db ]
    restart: always

  petcare-calificar:
    image: petcareregistry123.azurecr.io/petcare-calificar:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__Default=Server=db;Database=RatingDB;User Id=sa;Password=${DB_PASSWORD};TrustServerCertificate=True;
    depends_on: [ db ]
    restart: always

  petcare-frontend:
    image: petcareregistry123.azurecr.io/petcare-frontend:latest
    ports: [ "80:80" ]
    environment:
      - VITE_AUTH_API_URL=https://petcare-dss-app.azurewebsites.net/api/auth
      - VITE_CLIENT_API_URL=https://petcare-dss-app.azurewebsites.net/api/cliente
      - VITE_CAREGIVER_API_URL=https://petcare-dss-app.azurewebsites.net/api/cuidador
    depends_on: [ petcare-auth, petcare-cliente ]
    restart: always

volumes:
  sqlvolume:
